{% extends 'layouts/app.html' %} {% block css %}
<style>
  .titulo_seccion {
    font-weight: bold;
  }
  #video {
    width: 100%; /* Ajusta el tamaño según sea necesario */
    height: auto; /* Mantiene la proporción del video */
  }

  #snapshot_registro {
    width: 100%;
  }
  #modal_success .modal-content {
    background-color: rgb(0, 196, 75);
    color: white;
  }

  #txtUsuario {
    font-weight: bold;
  }
</style>
{% endblock %} {% block content %}
<div class="row mt-3">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-12">
            <h4 class="w-100 text-center">
              Autenticación para transacciones digitales en Telecomunicaciones
            </h4>
          </div>
          <div class="col-12 text-center">
            <button class="btn btn-primary" id="iniciaAuthenticacion">
              Iniciar Autenticación
            </button>
            <a
              href="#"
              id="btnRegistrarse"
              data-bs-toggle="modal"
              data-bs-target="#modal_registro"
              class="btn btn-outline-primary"
              >Registrarse</a
            >
          </div>
        </div>
        <div class="row mt-4" id="contenedorLoginFacial">
          <div class="col-md-4 mx-auto">
            <div class="verificandoUsuario">
              Verificando al usuario: <span id="txtUsuario"></span>
            </div>
            <img id="videoFacial" src="" style="width: 100%" height="auto" />
          </div>
        </div>
        <div class="row mt-4" id="contenedor_autenticacion">
          <div class="col-md-4 text-center">
            <span class="titulo_seccion">Tiempo restante</span>
          </div>
          <div class="col-md-4 text-center">
            <span class="titulo_seccion">Cámara</span>
            <img id="video" src="" style="width: 100%; height: auto" />
            <input
              type="text"
              id="emotion-output"
              class="form-control"
              placeholder="Emoción detectada"
              readonly
            />
          </div>
          <div class="col-md-4 text-center">
            <span class="titulo_seccion"
              >Muestre el siguiente número con la mano</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% include 'modal/registro.html' %} {% include 'modal/login.html' %} {% endblock
%} {% block scripts %}
<script>
  // LOGIN
  let login = false;
  let usuario_logeado = null;
  let usuarioLogin = document.getElementById("usuarioLogin");
  let btnLogin = document.getElementById("btnLogin");
  const txtUsuario = document.getElementById("txtUsuario");
  const modal_login = bootstrap.Modal.getOrCreateInstance(
    document.getElementById("modal_login")
  );
  const videoFacial = document.getElementById("videoFacial");
  let errorLogin = document.getElementById("errorLogin");
  errorLogin.parentNode.classList.add("oculto");
  const iniciaAuthenticacion = document.getElementById("iniciaAuthenticacion");

  const contenedorLoginFacial = document.getElementById(
    "contenedorLoginFacial"
  );
  const contenedor_autenticacion = document.getElementById(
    "contenedor_autenticacion"
  );

  contenedorLoginFacial.classList.add("oculto");
  contenedor_autenticacion.classList.add("oculto");

  iniciaAuthenticacion.addEventListener("click", () => {
    modal_login.show();
  });

  btnLogin.addEventListener("click", () => {
    fetch("/verifica_usuario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ usuario: usuarioLogin.value }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (typeof data.error != "undefined" || !data.existe) {
          errorLogin.parentNode.classList.remove("oculto");
          if (typeof data.error != "undefined") {
            errorLogin.innerHTML = data.error;
          } else {
            errorLogin.innerHTML = data.mensaje;
          }
        } else {
          usuario_logeado = data.usuario;
          txtUsuario.innerText = usuario_logeado.usuario;
          contenedorLoginFacial.classList.remove("oculto");
          usuarioLogin.value = "";
          modal_login.hide();
          login = true;
          isVideoActive = true;
          stop_camera();
          toggleVideo();
          ocultaValidaciones();
          iniciaLoginFacial();
        }
      })
      .catch((error) => console.error("Error:", error));
  });

  const iniciaLoginFacial = () => {};
  const ocultaValidaciones = () => {};
  const iniciaValidaciones = () => {};

  var interval_respuestas_emociones = null;
  var interval_respuestas_facial = null;
  const iniciaDeteccion = () => {
    document.getElementById("videoFacial").src = "";
    document.getElementById("video").src = "";
    if (login) {
      document.getElementById("videoFacial").src =
        "{{ url_for('video_feed') }}"; // Reactivar facial
      interval_respuestas_facial = setInterval(()=>{
        console.log("Reconociendo...")
        enviaRostroLogin();
      }, 4000);
    } else {
      document.getElementById("video").src = "{{ url_for('video_feed') }}"; // Reactivar emociones
      interval_respuestas_emociones = setInterval(async () => {
        const response = await fetch("/emotion");
        const data = await response.json();
        document.getElementById("emotion-output").value =
          data.emotion || "Error al detectar emoción";
      }, 1000);
    }
  };

  const enviaRostroLogin = async () => {
    try {
      const response = await fetch(
        `/login_facial?usuario=${encodeURIComponent(usuario_logeado.usuario)}`
      );
      const data = await response.json();
      console.log(data);
      if (data.existe) {
      } else {
      }
    } catch (error) {
      console.error("Error en el envío de rostro:", error);
    } finally {
      // Reprograma la función para ejecutarse después de 4 segundos
    }
  };
  addEventListener("DOMContentLoaded", (event) => {
    toggleVideo();
  });

  // REGISTRO
  var isVideoActive = false;
  let valida_img = false;
  let error_registro = document.getElementById("errorRegistro");
  error_registro.parentNode.classList.add("oculto");
  let modal_registro = bootstrap.Modal.getOrCreateInstance(
    document.getElementById("modal_registro")
  );
  let modal_success = bootstrap.Modal.getOrCreateInstance(
    document.getElementById("modal_success")
  );

  const btnRegistrarse = document.getElementById("btnRegistrarse");

  btnRegistrarse.addEventListener("click", (e) => {
    e.preventDefault();
    isVideoActive = false;
    toggleVideo(true);
  });

  // Acceder a la cámara del usuario
  const video_registro = document.getElementById("video_registro");
  const canvas_registro = document.getElementById("canvas_registro");
  const snapshot_registro = document.getElementById("snapshot_registro");
  const captureButton = document.getElementById("capture_registro");
  const registerButton = document.getElementById("register");

  // Obtener acceso a la cámara
  const initCamaraRegistro = () => {
    stream_camara = navigator.mediaDevices
      .getUserMedia({ video: true })
      .then((stream) => {
        video_registro.srcObject = stream;
      })
      .catch((err) => {
        console.error("Error al acceder a la cámara: ", err);
      });
  };

  // Capturar la imagen al hacer clic en el botón
  captureButton.addEventListener("click", () => {
    const context = canvas_registro.getContext("2d");

    // Dibuja el video en el canvas manteniendo la relación de aspecto
    const videoWidth = video_registro.videoWidth;
    const videoHeight = video_registro.videoHeight;

    // Ajustar el canvas a la relación de aspecto del video
    canvas_registro.width = videoWidth;
    canvas_registro.height = videoHeight;

    context.drawImage(
      video_registro,
      0,
      0,
      canvas_registro.width,
      canvas_registro.height
    );
    const dataUrl = canvas_registro.toDataURL("image/jpeg", 0.9);
    snapshot_registro.src = dataUrl;
    snapshot_registro.style.display = "block"; // Mostrar la imagen capturada
    valida_img = true;
  });

  // Enviar la captura y el usuario al servidor
  registerButton.addEventListener("click", () => {
    const usuario = document.getElementById("usuario").value;
    const imageData = canvas_registro.toDataURL("image/jpeg", 0.9);
    if (valida_img && usuario.trim() != "") {
      error_registro.parentNode.classList.add("oculto");
      // Enviar la imagen y el nombre de usuario al servidor
      fetch("/registrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          usuario: usuario,
          imagen: imageData,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            error_registro.parentNode.classList.remove("oculto");
            error_registro.innerHTML = data.error;
          } else {
            modal_registro.hide();
            modal_success.show();
            setTimeout(() => {
              modal_success.hide();
            }, 800);
            // Manejar la respuesta del servidor
          }
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    } else {
      error_registro.parentNode.classList.remove("oculto");
      error_registro.innerHTML = "Debes ingresar el usuario y tomar la captura";
    }
  });

  const stop_camera = () => {
    const mediaStream = video_registro.srcObject;
    if (mediaStream) {
      const tracks = mediaStream.getTracks();
      tracks[0].stop();
      tracks.forEach((track) => track.stop());
    }
  };

  // Iniciar la cámara
  function toggleVideo(registro = false) {
    fetch("/toggle_video", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ active: isVideoActive }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (!isVideoActive) {
          document.getElementById("videoFacial").src = ""; // Desactivar imagen
          document.getElementById("video").src = ""; // Desactivar imagen
          clearInterval(interval_respuestas_emociones);
          clearInterval(interval_respuestas_facial);
          if (registro) {
            initCamaraRegistro();
          }
        } else {
          iniciaDeteccion();
        }
      })
      .catch((error) => console.error("Error:", error));
  }
</script>
{% endblock %}
